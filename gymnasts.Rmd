---
title: "gymnasts"
output: html_document
date: "2024-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Instalar y cargar las librerías necesarias
paquetes_necesarios <- c("dplyr", "tidyr", "formattable", "htmltools", "webshot")
paquetes_nuevos <- paquetes_necesarios[!(paquetes_necesarios %in% installed.packages()[, "Package"])]
if (length(paquetes_nuevos)) install.packages(paquetes_nuevos)

# Cargar las librerías
library(dplyr)
library(tidyr)
library(formattable)
library(htmltools)
library(webshot)

# Configurar Webshot para guardar tablas
webshot::install_phantomjs()

```

```{r}
# Cargar las librerías necesarias
library(readr)
library(dplyr)

# Definir la URL del archivo CSV
url <- "https://raw.githubusercontent.com/ucsas/gym2024data/main/cleandata/data_2022_2023.csv"

# Descargar y leer el archivo CSV
datos_gimnasia <- read_csv(url)

# Mostrar las primeras filas del conjunto de datos
head(datos_gimnasia)


#get columns names
colnames(datos_gimnasia)


```



```{r}
## Preprocesamiento de datos

# Agregar el número de fila como índice
datos_gimnasia <- datos_gimnasia %>%
  mutate(Indice = row_number())

# Seleccionar columnas relevantes
datos_evaluacion <- datos_gimnasia %>%
  select(Indice, Competition, Round, D_Score, E_Score, Penalty)

# Verificar valores únicos en Competencia y Ronda
unique(datos_evaluacion$Competition)  # Competitions
unique(datos_evaluacion$Round)        # Rounds

# Reemplazar valores NA en Penalty con 0
datos_evaluacion <- datos_evaluacion %>%
  mutate(Penalty = ifelse(is.na(Penalty), 0, Penalty))

# Normalizar columnas numéricas (D_Score, E_Score, Penalty)
datos_evaluacion <- datos_evaluacion %>%
  mutate(
    D_Score_Norm = D_Score / max(D_Score, na.rm = TRUE),
    E_Score_Norm = E_Score / max(E_Score, na.rm = TRUE),
    Penalty_Norm = 1 - (Penalty / max(Penalty, na.rm = TRUE))  # Invert penalty for ranking
  )
```

## Asignación de Importancia a las Rondas

La importancia de cada ronda se asigna basándonos en su relevancia dentro de la competencia. A continuación, se detalla el razonamiento utilizado:

1. **AAfinal (5 puntos):** Representa la máxima competencia individual, donde los gimnastas compiten por el ranking general en múltiples aparatos.
2. **TeamFinal (4 puntos):** Competencia de equipos con alta relevancia, pero menos enfocada en el rendimiento individual.
3. **final (4 puntos):** Final por aparatos que determina a los mejores gimnastas en categorías específicas.
4. **AAqual (3 puntos):** Clasificación para el All-Around Final, importante pero no decisivo.
5. **TeamQual (2 puntos):** Clasificación por equipos, preliminar en naturaleza.
6. **qual (1 punto):** Primera ronda, con menor peso competitivo.

Estos valores se integran en el análisis multicriterio para reflejar la importancia relativa de cada ronda dentro de la evaluación global.


```{r}
# Definir la importancia de las rondas
orden_importancia <- c("AAfinal", "TeamFinal", "final", "AAqual", "TeamQual", "qual")
importancia_rondas <- data.frame(
  Round = orden_importancia,
  Ronda = rev(seq_along(orden_importancia))  # Secuencia inversa para asignar importancia
)

# Combinar las rondas con los datos de evaluación
datos_evaluacion <- datos_evaluacion %>%
  left_join(importancia_rondas, by = "Round")

# Verificar los datos con la importancia asignada
head(datos_evaluacion)
```



## Asignación de Importancia a las Competiciones

La importancia de cada competencia se asigna en función de su prestigio, alcance geográfico y relevancia competitiva. Se han definido las siguientes categorías:

1. **Prestigio Global (5 puntos):** Competiciones como los Campeonatos del Mundo de FIG, Campeonatos Europeos, Juegos Panamericanos y Juegos Asiáticos, que tienen la mayor relevancia.
2. **Ámbito Regional (4 puntos):** Copas del Mundo, Campeonatos Continentales Senior, y Campeonatos Nacionales importantes como los de EE.UU.
3. **Competencias Específicas (3 puntos):** Copas Challenge, Campeonatos Británicos y eventos similares con prestigio moderado.
4. **Eventos Menores (2 puntos):** Clásicos de EE.UU., Winter Cup, y eventos invitacionales.
5. **Eventos Locales (1 punto):** Eventos más pequeños o con menor impacto global.

### Implementación en el Código

```{r asignar-importancia-competencias}
# Definir importancia de las competencias
importancia_competencias <- data.frame(
  Competition = c("2022 Cottbus World Cup", "2023 Cottbus World Cup",
                  "2023 FISU World University Games", "2022 51st FIG Artistic Gymnastics World Championships",
                  "2022 Senior European Championships", "2023 52nd FIG Artistic Gymnastics World Championships",
                  "2023 Senior European Championships", "2023 Tel Aviv World Challenge Cup",
                  "2023 Baku World Cup", "2022 Cairo World Cup", "2022 Paris World Challenge Cup",
                  "2023 Cairo World Cup", "2023 Doha World Cup", "2023 10th Senior Artistic Gymnastics Asian Championships",
                  "2022 British Gymnastics Championships", "2022 9th Senior Artistic Gymnastics Asian Championships",
                  "2022 Baku World Cup", "2022 Doha World Cup", "2023 Varna World Challenge Cup",
                  "BIRMINGHAM 2022 Commonwealth Games", "2023 Artistic Gymnastics Senior Pan American Championships",
                  "HANGZHOU 2022 19th Asian Games", "2023 British Gymnastics Championships",
                  "2022 Osijek World Challenge Cup", "SANTIAGO 2023 XIX Pan American Games",
                  "2023 Central American and Caribbean Games", "2022 U.S. Classic", "2022 Mersin World Challenge Cup",
                  "2023 Osijek World Challenge Cup", "2022 Szombathely World Challenge Cup",
                  "2022 Varna World Challenge Cup", "2023 Core Hydration Classic", "2022 U.S. Championships",
                  "2023 U.S. Championships", "2023 Winter Cup", "2022 Winter Cup", "EnBW DTB Pokal Team Challenge 2023",
                  "2022 Koper World Challenge Cup", "Oceania Continental Championships 2023"),
  Competicion = c(4, 4, 3, 5, 5, 5, 5, 3, 4, 4, 3, 4, 4, 5, 3, 5, 4, 4, 3, 5, 5, 5, 3, 3, 5, 4, 2, 3, 3, 3, 3, 3, 4, 4, 2, 2, 3, 3, 4)
)

# Combinar la importancia con los datos de evaluación
datos_evaluacion <- datos_evaluacion %>%
  left_join(importancia_competencias, by = "Competition")

# Verificar los datos con la importancia asignada
head(datos_evaluacion)
```

```{r}
datos_evaluacion_limpios <- datos_evaluacion %>%
  select(Indice, Competicion, Ronda, D_Score_Norm, E_Score_Norm, Penalty_Norm)

head(datos_evaluacion_limpios)
```


## AHP - Análisis Multicriterio

```{r}
# load functions from ~/poli/TD/TDecisionCodigo/teoriadecision_funciones_multicriterio.R
source("~/poli/TD/TDecisionCodigo/teoriadecision_funciones_multicriterio.R")
# source("~/poli/TD/TDecisionCodigo/teoriadecision_funciones_multicriterio_utiles.R")
# source("~/poli/TD/TDecisionCodigo/teoriadecision_funciones_multicriterio_diagram.R")


# Define pairwise comparison matrix for criteria
vector_criterios <- c(1, 3, 5, 7, 9, 1/3, 1, 4, 6, 8, 1/5, 1/4, 1, 3, 7, 1/7, 1/6, 1/3, 1, 5, 1/9, 1/8, 1/7, 1/5, 1)
matriz_criterios <- multicriterio.crea.matrizvaloraciones(vector_criterios, numalternativas = 5, v.nombres.alternativas = c("Competencia", "Ronda", "D_Score", "E_Score", "Penalización"))

# Check matrix
matriz_criterios

```


```{r}
# Compute AHP weights using the Eigenvector method
ahp_result <- multicriterio.metodoAHP.variante1.autovectormayorautovalor(matriz_criterios)

# Display weights
ahp_result$valoraciones.ahp

# Check consistency
consistency <- multicriterio.metodoAHP.coef.inconsistencia(matriz_criterios)
consistency$mensaje
```


Dada la gran cantidad de alternativas (24,000 gimnastas), realizar comparaciones por pares entre todas las alternativas no es práctico debido al costo computacional. Por ello, utilizamos un enfoque basado en una matriz de decisión, donde cada gimnasta se evalúa directamente en función de los criterios normalizados y ponderados. Este método es escalable y flexible.




```{r}
# Decision matrix for alternatives (gymnast performances)
vector_alternativas <- c(
  1, 3, 5, 7, 2,
  1/3, 1, 4, 6, 1/2,
  1/5, 1/4, 1, 3, 1/7,
  1/7, 1/6, 1/3, 1, 1/9,
  1/2, 2, 7, 9, 1
)

matriz_alternativas <- multicriterio.crea.matrizdecision(vector_alternativas, numalternativas = 5, numcriterios = 5, v.nombresalt = c("Gymnast1", "Gymnast2", "Gymnast3", "Gymnast4", "Gymnast5"), v.nombrescri = c("Competencia", "Ronda", "D_Score", "E_Score", "Penalización"))

# Homogenize and normalize
decision_homogenea <- multicriterio.homogeneizacion.nadir(matriz_alternativas)

# Combine weights with the alternatives
pesos_globales <- multicriterio.metodoAHP.pesosglobales(ahp_result$valoraciones.ahp, decision_homogenea)

# Display results
pesos_globales

```



